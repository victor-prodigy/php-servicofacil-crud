/**
 * üìù ALTERAR SOLICITA√á√ÉO DE SERVI√áO - JavaScript
 * Funcionalidades para carregar e atualizar dados da solicita√ß√£o
 */

// üéØ Vari√°veis globais
let solicitacaoId = null;

// üöÄ Inicializa√ß√£o quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function () {
  // Obter ID da solicita√ß√£o da URL
  const urlParams = new URLSearchParams(window.location.search);
  solicitacaoId = urlParams.get('id');

  if (!solicitacaoId) {
    showAlert('error', 'ID da solicita√ß√£o n√£o foi fornecido.');
    setTimeout(() => {
      window.location.href = '../cliente-dashboard.html';
    }, 3000);
    return;
  }

  // Carregar dados da solicita√ß√£o
  carregarDadosSolicitacao();

  // Configurar form submit
  const form = document.getElementById('alterarSolicitacaoForm');
  form.addEventListener('submit', handleFormSubmit);

  // Configurar contadores de caracteres
  setupCharacterCounters();
});

/**
 * üì• Carregar dados da solicita√ß√£o existente
 */
async function carregarDadosSolicitacao() {
  try {
    showLoading(true);

    console.log('Carregando solicita√ß√£o ID:', solicitacaoId);

    const response = await fetch(`../../php/servico/obter-solicitacao.php?id=${solicitacaoId}`);

    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
    }

    const data = await response.json();

    console.log('Dados recebidos:', data);

    if (!data.success) {
      throw new Error(data.message);
    }

    // Preencher formul√°rio com os dados
    preencherFormulario(data.solicitacao);

    showLoading(false);
    showForm(true);

  } catch (error) {
    console.error('Erro ao carregar solicita√ß√£o:', error);
    showAlert('error', 'Erro ao carregar dados da solicita√ß√£o: ' + error.message);
    showLoading(false);

    setTimeout(() => {
      window.location.href = '../cliente-dashboard.html';
    }, 3000);
  }
}

/**
 * üìù Preencher formul√°rio com dados da solicita√ß√£o
 */
function preencherFormulario(solicitacao) {
  document.getElementById('solicitacao_id').value = solicitacao.request_id;
  document.getElementById('titulo').value = solicitacao.titulo || '';
  document.getElementById('categoria').value = solicitacao.categoria || '';
  document.getElementById('descricao').value = solicitacao.descricao || '';
  document.getElementById('endereco').value = solicitacao.endereco || '';
  document.getElementById('cidade').value = solicitacao.cidade || '';
  document.getElementById('prazo_desejado').value = solicitacao.prazo_desejado || '';
  document.getElementById('orcamento_maximo').value = solicitacao.orcamento_maximo || '';
  document.getElementById('observacoes').value = solicitacao.observacoes || '';

  // Formatar status para exibi√ß√£o
  const statusFormatado = formatarStatus(solicitacao.status);
  document.getElementById('status').value = statusFormatado;

  // Atualizar contadores de caracteres
  updateCharacterCount(document.getElementById('descricao'), 500);
  updateCharacterCount(document.getElementById('observacoes'), 300);
}

/**
 * üè∑Ô∏è Formatar status para exibi√ß√£o
 */
function formatarStatus(status) {
  const statusMap = {
    'pendente': 'Pendente',
    'em_andamento': 'Em Andamento',
    'concluido': 'Conclu√≠do',
    'cancelado': 'Cancelado'
  };
  return statusMap[status] || status;
}

/**
 * üì§ Processar envio do formul√°rio
 */
async function handleFormSubmit(event) {
  event.preventDefault();

  try {
    // Desabilitar bot√£o durante envio
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';

    // Preparar dados do formul√°rio
    const formData = new FormData();
    formData.append('solicitacao_id', document.getElementById('solicitacao_id').value);
    formData.append('titulo', document.getElementById('titulo').value.trim());
    formData.append('categoria', document.getElementById('categoria').value);
    formData.append('descricao', document.getElementById('descricao').value.trim());
    formData.append('endereco', document.getElementById('endereco').value.trim());
    formData.append('cidade', document.getElementById('cidade').value.trim());
    formData.append('prazo_desejado', document.getElementById('prazo_desejado').value);
    formData.append('observacoes', document.getElementById('observacoes').value.trim());

    // Or√ßamento m√°ximo (opcional)
    const orcamento = document.getElementById('orcamento_maximo').value;
    if (orcamento && orcamento.trim() !== '') {
      formData.append('orcamento_maximo', orcamento);
    }

    // Enviar para o servidor
    const response = await fetch('../../php/servico/altera-solicitacao.php', {
      method: 'POST',
      body: formData
    });

    // Verificar se a resposta HTTP foi bem-sucedida
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
    }

    const data = await response.json();

    if (data.success) {
      showAlert('success', data.message);

      // Redirecionar ap√≥s sucesso
      setTimeout(() => {
        window.location.href = '../cliente-dashboard.html';
      }, 2000);
    } else {
      throw new Error(data.message);
    }

  } catch (error) {
    console.error('Erro detalhado:', error);

    // Mostrar erro mais detalhado para debug
    let errorMessage = 'Erro ao atualizar solicita√ß√£o: ' + error.message;

    // Se for erro de rede ou parsing
    if (error.name === 'TypeError' || error.name === 'SyntaxError') {
      errorMessage += '\n\nVerifique:\n- Se o servidor est√° funcionando\n- Se os arquivos PHP est√£o corretos\n- Se h√° erros de sintaxe';
    }

    showAlert('error', errorMessage);
  } finally {
    // Reabilitar bot√£o
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Altera√ß√µes';
  }
}

/**
 * üí¨ Exibir alertas
 */
function showAlert(type, message) {
  const alertArea = document.getElementById('alert-area');
  const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
  const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

  alertArea.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${iconClass} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

  // Auto-hide ap√≥s 5 segundos se for sucesso
  if (type === 'success') {
    setTimeout(() => {
      const alert = alertArea.querySelector('.alert');
      if (alert) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }
    }, 5000);
  }

  // Scroll para o topo
  alertArea.scrollIntoView({ behavior: 'smooth' });
}

/**
 * ‚è≥ Controlar exibi√ß√£o do loading
 */
function showLoading(show) {
  const loadingIndicator = document.getElementById('loadingIndicator');
  loadingIndicator.style.display = show ? 'block' : 'none';
}

/**
 * üìã Controlar exibi√ß√£o do formul√°rio
 */
function showForm(show) {
  const formCard = document.getElementById('formCard');
  formCard.style.display = show ? 'block' : 'none';
}

/**
 * üéõÔ∏è Configurar contadores de caracteres
 */
function setupCharacterCounters() {
  const descricaoField = document.getElementById('descricao');
  const observacoesField = document.getElementById('observacoes');

  if (descricaoField) {
    descricaoField.addEventListener('input', function () {
      updateCharacterCount(this, 500);
    });
  }

  if (observacoesField) {
    observacoesField.addEventListener('input', function () {
      updateCharacterCount(this, 300);
    });
  }
}

/**
 * üî¢ Atualizar contador de caracteres
 */
function updateCharacterCount(element, maxLength) {
  const currentLength = element.value.length;
  const formText = element.parentNode.querySelector('.form-text');

  if (formText) {
    const remaining = maxLength - currentLength;
    const originalText = formText.textContent;

    // Manter texto original se n√£o for contador
    if (!originalText.includes('caracteres')) {
      formText.textContent = `${originalText} (${currentLength}/${maxLength} caracteres)`;
    } else {
      formText.textContent = `${currentLength}/${maxLength} caracteres`;
    }

    if (remaining < 50) {
      formText.style.color = remaining < 0 ? '#dc3545' : '#fd7e14';
    } else {
      formText.style.color = '#6c757d';
    }
  }
}

/**
 * üîÑ Fun√ß√£o para recarregar dados (caso necess√°rio)
 */
function recarregarDados() {
  showForm(false);
  carregarDadosSolicitacao();
}

/**
 * üßπ Fun√ß√£o de valida√ß√£o adicional do formul√°rio
 */
function validarFormulario() {
  const titulo = document.getElementById('titulo').value.trim();
  const categoria = document.getElementById('categoria').value;
  const descricao = document.getElementById('descricao').value.trim();
  const endereco = document.getElementById('endereco').value.trim();
  const cidade = document.getElementById('cidade').value.trim();
  const prazoDesejado = document.getElementById('prazo_desejado').value;

  if (!titulo) {
    showAlert('error', 'T√≠tulo √© obrigat√≥rio.');
    return false;
  }

  if (!categoria) {
    showAlert('error', 'Categoria √© obrigat√≥ria.');
    return false;
  }

  if (!descricao) {
    showAlert('error', 'Descri√ß√£o √© obrigat√≥ria.');
    return false;
  }

  if (!endereco) {
    showAlert('error', 'Endere√ßo √© obrigat√≥rio.');
    return false;
  }

  if (!cidade) {
    showAlert('error', 'Cidade √© obrigat√≥ria.');
    return false;
  }

  if (!prazoDesejado) {
    showAlert('error', 'Prazo desejado √© obrigat√≥rio.');
    return false;
  }

  return true;
}